---
title: "Clustering Race Horse Movement Profiles to Discover Trends in Injured Horses"
author: "Sara Colando^[Pomona College, skca2020@mymail.pomona.edu], Jonathan Pipping^[University of Florida, jonathan.pipping@ufl.edu], and Kris Wilson^[North Carolina State University, kawilso7@ncsu.edu]"
date: "July 28th, 2023"
output: 
  bookdown::html_document2:
    toc: TRUE
    toc_float: TRUE
    toc-collapse: TRUE
    number_sections: FALSE
    theme: flatly
bibliography: final-project.bib
link-citations: TRUE
csl: norsk-apa-manual.csl
css: project-report.css
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align = "center", warning = FALSE, message = FALSE)
library(lubridate)
library(broom)
library(MASS)
library(tidyverse)
library(ggiraph)
library(forcats)
library(gridExtra)
library(ggthemes)
library(grid)
```


----

## Executive Summary

Between 2009 and 2021, over 7,200 horses died or were euthanized due to racing-related injuries [@Fobar-2023]. Using horse profile data and horse tracking data from the NYRA, we hoped to identify horses who under-raced between 2019 and 2021, cluster movement profiles for horses who raced in 2019 New York races, and discover whether certain profiles were more associated with injured horses.

By fitting a negative binomial model on horse profile data and performing residual analysis, we discovered that at least 251 horses under-raced between 2019 and 2021. Additionally, clustering horse movement profiles revealed that a horse's speed profile is most associated with its injury status: specifically, greater variation in speed is more associated with injury.

----

## Introduction

Between 2009 and 2021, over 7,200 horses died or were euthanized due to racing-related injuries [@Fobar-2023]. Just a month ago, the Churchill Downs in Kentucky had to suspend races because twelve horses have sustained fatal injuries at the track this spring season [@Romero-2023]. Several horse racing associations in the United States, such as the New York Racing Association (NYRA), are invested in lowering the prevalence of race-related injuries by understanding what increases injury risk [@NYRA-safety].

At the same time, horse racing data has significantly advanced in recent years. In 2022, the New York Racing Association (NYRA) and New York Thoroughbred Horsemen’s Association (NYTHA) co-sponsored the first-ever Big Data Derby, where horse tracking data was released for public analysis. The released data includes several metrics that had been previously unavailable in horse racing, such as the horse’s longitude and latitude every 0.25 seconds in the race [@big-data-derby-2022]. 

**With the newly-available tracking data, we hope to discover whether certain movement patterns are common for horses who became injured in 2019. In particular, through this project, we aim to contribute the following:**

>1. Identify horses who under-raced between 2019 and 2021 to expand the subset of injured horses, from just being those who had a severe injured reported.

>2. Cluster movement profiles for horses who raced in a New York race in 2019 using the newly-available horse tracking data. 

>3. Discover whether certain movement clusters are more likely to be associated with horses who become injured in 2019.

We hope that analyzing the movement profiles of horses with the tracking data will help NYRA (and other racing associations) accomplish their goal of reducing the occurrence of race-related injuries and fatalities in horses by seeing whether certain movement profiles are riskier for horses. 

----

## Data

#### Horse Profiles: 

The horse profiles data set includes details about each horse who was tracked in a NYRA race during 2019. In the final data set, there are 4,589 unique horses and 40 variables. Each observation in the data set represents a horse and their relevant information, such as the number of races they competed in during 2019, summary statistics for their days between races, and their injury status. We used three sources to collect data about each tracked horse. First, we ascertained severe injury and fatality data through Joe Appelbaum at NYRA. Similarly, we received a list of all horses who started at a NYRA track between 2019 and 2021 from Joe Appelbaum. The relevant variables from the horse profiles data set include:

* **If Injury Reported**: whether the horse became severely injured at a NYRA track.

* **Fatal**: whether the horse's reported severe injury was fatal or not.

* **Ever Under-Raced**: whether the horse under-raced given their age (in years) and the calendar year (the method used to classify a horse as "under-racing" is described in the methods section below).


#### Horse Tracking Data:

The horse tracking data set includes information about each tracked NYRA race during 2019. The original data set was publicized as part of the 2022 NYTHA/NYRA Big Data Derby [@big-data-derby-2022] and includes 25 variables for 4,589 unique horses who competed in at least one of 1,991 races for a total of 5,162,881 observations. Each observation in the data set represents a single horse's position at a particular frame within a race, represented as longitude and latitude. With the help of data cleaning functions from Brendan Kumagai and his team [@canadian-pharoah], we converted horse positions to Cartesian coordinates (in meters) and produced horse trajectories for each of the following metrics:

* **Speed**: a horse's speed (in meters per second) in the current frame.

* **Acceleration**: a horse's acceleration (in meters per second squared) in the current frame.

* **Lateral Movement**: a horse's side-to-side movement (in meters) from the previous frame to the current frame.

----

### Exploratory Data Analysis (EDA)

Before identifying under-racing horses through an expected counts model, we visualized some key variables with the NYRA Start List Data Set; namely, we visualized the relationship between horse age and race count and the relationship between calendar year and race count to have a better sense of how these variables are associated with a horse's race count.

```{r}
horse_names <- read_csv("../horse-cooking-data/horse_names.csv")
participation_data <- read_csv("../horse-cooking-data/horses_3years_racing_NYRA.csv") |>
  rename(horse_name = `horse name`,
         birth_date = `birth date`,
         race_date = `race date`) |>
  drop_na(horse_name)

horse_profiles_injured <- read_csv("../outputted-csvs/horse_profiles.csv") |>
  filter(if_injury_reported == TRUE) 

#### append horse names to participation data ####
## remove 2022 because only race from that year is from 01/01/2022

id_participation_data <- participation_data |>
  left_join(horse_names, by = 'horse_name') |>
  mutate(race_year = year(race_date)) |>
  filter(!(race_year == 2022))

EDA_data <-id_participation_data |>
  mutate(
    age = as.period(interval(start = birth_date, end = race_date)),
    age_year = year(age),
    race_year = as.factor(race_year)) |> 
  drop_na(horse_id, age_year) |> 
  group_by(horse_id, age_year, race_year) |> 
  summarize(n_races = n(), .groups = "keep")
```

```{r}
EDA_underrace_1 <- id_participation_data |>
  mutate(
    age = as.period(interval(start = birth_date, end = race_date)),
    age_year = year(age)) |>
  group_by(horse_id, age_year) |>
  summarize(n_races = n()) |>
  drop_na() |>
  ggplot(aes(x = age_year, y = n_races))+
  geom_point(alpha = 0.3)+
  geom_smooth(method = "lm", color = "#e15759", fill = "#edc948")+
  scale_x_continuous(breaks = seq(0,10,1))+
  scale_y_continuous(breaks = seq(0,25,2))+
  labs(x = "Horse's Age (in Years)", y = "Number of Races")+
  theme_minimal()
```

```{r}
EDA_underrace_2 <- id_participation_data |>
  mutate(
    age = as.period(interval(start = birth_date, end = race_date)),
    age_year = year(age),
    race_year = as.factor(race_year)) |>
  mutate(race_year = fct_relevel(race_year, "2021", "2020", "2019")) |>
  group_by(horse_id, race_year) |>
  summarize(n_races = n()) |>
  drop_na() |>
  ggplot(aes(y = race_year, x = n_races))+
  geom_violin(aes(fill = race_year, color = race_year), alpha = 0.3)+
  geom_boxplot(aes(color = race_year), width = 0.2)+
  scale_fill_tableau()+
  scale_color_tableau()+
  labs(x = "Number of Races", y = "Calendar Year")+
  scale_x_continuous(breaks = seq(0,30,2))+
  theme_minimal()+
  theme(legend.position = "none")
```

```{r EDA-under-race, fig.cap= "Exploratory Data Analysis for Expected Race Count Model"}
grid.arrange(EDA_underrace_1, EDA_underrace_2, nrow=1)
```

**Figure \@ref(fig:EDA-under-race) Key Takeaways:** The left side of Figure \@ref(fig:EDA-under-race) depicts the relationship between a horse's age (in years) and their number of races, fit with a simple linear regression model. From the regression line, we see that as horse's age (in years) increases, the expected number of races the horse will compete in increases as well for horse's between 1 and 10 years-old. The plot does not give us any indication that we should treat horse's age as a factored predictor rather than a continuous variable. The right side of Figure \@ref(fig:EDA-under-race) illustrates the relationship between the calendar year and each horse's number of races in that year. The change in median number of races from 2019 to 2020 against the change in median number of races from 2020 to 2021, solidifies that we should treat calendar year as a factored variable (rather than continuous variable) in our expected race count model.

Before computing summary statistics and clustering horse movement profiles, we visualized horse trajectories from the 2019 NYRA Horse Tracking Data Set; namely, we visualized the position, speed, acceleration, lateral movement, cumulative lateral movement, and STRAIN for horses who ran at the Aqueduct on April 19th, 2019. These visualizations provide a better understanding of common patterns of horse movement throughought a race.

```{r}
# load horse data ####

horse_data <- read_csv('../processed-horse-data/final_horse_strains.csv')

track_outline <- read_csv('../processed-horse-data/track_outlines_for_viz.csv') |> 
  filter(track_id == 'AQU',
         course_type == 'D')

# visualizing a race (race) ####

# visualize horse trajectories
race <- horse_data %>%
  filter(track_id == "AQU",
         race_date  == "2019-04-19",
         race_number == 1) %>%
  arrange(horse_id, frame_id) %>%
  ggplot(aes(x = x,
             y = y)) +
  geom_path(show.legend = FALSE,
            aes(color = as.factor(horse_name),
                group = as.factor(horse_name))) +
  # display track outlines
  geom_path(data = track_outline, show.legend = FALSE,
            aes(group = as.factor(outline_type))) +
  labs(x = 'x (m)',
       y = 'y (m)') +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

# speed vs time (speed) ####

speed <- horse_data %>%
  filter(track_id == "AQU",
         race_date  == "2019-04-19") %>%
  ggplot(aes(x = (frame_id / 4),
             y = speed,
             color = factor(horse_name))) +
  geom_line(show.legend = FALSE) +
  labs(title = 'Speed vs Time for Each Horse',
       subtitle = 'At the Aqueduct on April 19th, 2019',
       x = 'Time (s)',
       y = 'Speed (m/s)') +
  facet_wrap(~ race_number) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))

# acceleration vs time (accel) ####

accel <- horse_data %>%
  filter(track_id == "AQU",
         race_date  == "2019-04-19") %>%
  ggplot(aes(x = (frame_id / 4),
             y = acceleration,
             color = factor(horse_name))) +
  geom_line(show.legend = FALSE) +
  labs(title = 'Acceleration vs Time for Each Horse',
       subtitle = 'At the Aqueduct on April 19th, 2019',
       x = 'Time (s)',
       y = 'Acceleration (m/s^2)') +
  facet_wrap(~ race_number) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))

# load 1600m horse data ####

horse_data_1600 <- read_csv('../processed-horse-data/lateral_movement_1600.csv')

# lateral movement vs time (lat) ####

lat <- horse_data_1600 %>%
  filter(track_id == "AQU",
         race_date  == "2019-04-19") %>%
  ggplot(aes(x = (frame_id / 4),
             y = abs(side_movement),
             color = factor(horse_name))) +
  geom_line(show.legend = FALSE) +
  labs(title = 'Lateral Movement vs Time for Each Horse',
       subtitle = 'At the Aqueduct on April 19th, 2019',
       x = 'Time (s)',
       y = 'Lateral Movement (m)') +
  facet_wrap(~ race_number) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))

# cumulative lateral movement vs time (cum_lat) ####

cum_lat <- horse_data_1600 %>%
  filter(track_id == "AQU",
         race_date  == "2019-04-19") %>%
  group_by(horse_id) %>%
  mutate(cum_side_movement = cumsum(abs(side_movement))) %>%
  ggplot(aes(x = frame_id / 4,
             y = cum_side_movement,
             color = factor(horse_name))) +
  geom_line(show.legend = FALSE) +
  labs(title = 'Cumulative Lateral Movement vs Time for Each Horse',
       subtitle = 'At the Aqueduct on April 19th, 2019',
       x = 'Time (s)',
       y = 'Cumulative Lateral Movement (m)') +
  facet_wrap(~ race_number) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))
```

```{r race, fig.cap = 'Horse Tracking Data from Race 1 at The Aqueduct on April 19th, 2019"}
grid.arrange(race, nrow = 1)
```

**Figure \@ref(fig:race) Key Takeaways:**: Figure \@ref(fig:race) depicts the movement of 6 horses during Race 1 at the Aqueduct Racetrack on April 19th, 2019. It is a one-turn, 1600-meter race that culminates at the vertical finish line on the upper side of the track.

```{r rates, fig.cap = "Speed and Acceleration Trajectories from the Aqueduct on April 19th, 2019"}
grid.arrange(speed, accel, nrow=1)
```

**Figure \@ref(fig:rates) Key Takeaways:**: The left side of Figure \@ref(fig:rates) depicts the speed trajectories for each horse who raced at the Aqueduct Racetrack on April 19th, 2019. Typical speed curves are characterized by a steep increase at the start of the race followed by a slow decrease as the race goes on as seen in Races 1, 2, and 6. However, Races 3, 5, and 9 deviate from this pattern and are defined instead by a plateau in speed as the race progresses. The right side of \@ref(fig:rates) depicts the acceleration trajectories for each horse (which correspond to their speed trajectories). Typical acceleration curves are characterized by a spike at the start the race followed by an immediate decrease. Volatility around 0 $\frac{m}{s^2}$ ensues as horses jockey for position. We hypothesize that wide fluctuations in velocity and acceleration may be associated with increased injury risk.

```{r lateral, fig.cap = "Lateral Movement Trajectories from the Aqueduct on April 19th, 2019"}
grid.arrange(lat, cum_lat, nrow=1)
```

**Figure \@ref(fig:lateral) Key Takeaways:**: The left side of Figure \@ref(fig:lateral) depicts the lateral movement trajectories for each horse who raced at the Aqueduct Racetrack on April 19th, 2019. Typical lateral movement trajectories sometimes include a spike at the start of the race as horses move to the inner rail, but the widest oscillations ensue in the middle / final stages of a race as horses jockey for position. The right side of Figure \@ref(fig:lateral) depicts the cumulative lateral movement trajectories for each horse (which correspond to their lateral movement trajectories). These curves are strictly increasing, and though they tend to move together, some horses show significant deviation in cumulative lateral movement accumulated throughout a race, which we hypothesize may be associated with increased injury risk.

```{r strain over time}
strainz <- horse_data %>%
  filter(track_id == "AQU",
         race_date  == "2019-04-19") %>%
  ggplot(aes(x = (frame_id / 4),
             y = avg_strain,
             color = factor(horse_name))) +
  geom_line(show.legend = FALSE) +
  labs(title = 'Average Strain vs Time for Each Horse',
       subtitle = 'At the Aqueduct on April 19th, 2019',
       x = 'Time (s)',
       y = 'Speed (m/s)') +
  facet_wrap(~ race_number) +
  theme_minimal() +
  ylim(c(-5, 25)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))
```

```{r strainz, fig.cap = "Strain Trajectories from the Aqueduct on April 19th, 2019"}
grid.arrange(strainz, nrow=1)
```

**Figure \@ref(fig:strainz) Key Takeaways:**: Figure \@ref(fig:strainz) illustrates the average strain rate trajectories for each horse who raced at the Aqueduct Racetrack on April 19th, 2019. Typical strain trajectories depict include a spike at the start of the race as horses move to the inner rail, rapidly decreasing the distance between one another. As the race goes on, strain rate over time oscillates around zero, as the shape of the pack doesn't change over the middle portion of the race. Interestingly enough, we see some patterns begin to emerge: race four (4) depicts one horse's strain rate increasing for a brief moment while the other horses decrease--this horse is possibly making a move to get into the lead. Conversely, race three (3) depicts a slow shift by all the horses in the race from little-to-no strain to positive strain during the last 25-30 seconds of the race. This could indicate horses jockeying for position during a sprint to the end; the less distance between horses, the more likely it is for one horse to bump into another, potentially increasing the risk of injury.

----

## Methods


### Identifying Horses who Under-Raced 

Given only 122 out of 4589 horses (2.65%) had reported severe injuries, it would be unlikely that we would have enough injury signal to discover movement trends in injured horses if we just considered severely injured horses. To generate more injury signal, we posited that horses who under-raced relative to other horses their age in a calendar year had more subtle injuries. We could only analyze 931 unique horses for under-racing given we only wanted to include horses who raced in 2019 and the start list data for such horses was limited. Therefore, only 20% of the tracked horses could be evaluated for under-racing.

We chose to control for horse age (in years) and the calendar year because the expected number of races for a 2 year old horse would be very different than the expected race count for a 10 year old horse in the same calendar year. Similarly, we would expect the race count for horse that is 4 years old in 2019 to be different than a horse who is 4 years old in 2020 given the COVID-19 pandemic. Therefore, we developed a model of expected race counts based on the horse's age (in years) and the calendar year (ranging from 2019-2021) to expand our set of injured horses. 

Given we wanted to find an expected count, we considered using both Poisson and Negative Binomial models. Due to the presence of overdispersion in our data, we ultimately opted to use the Negative Binomial model to determine the expected number of races for each horse given their age and the calendar year [@NB-model]. Per Figure \@ref(fig:EDA-under-race), we treated horse's age as continuous and the calendar year as a factor.

**Hence, we fit the following Negative Binomial model:**

$$\text{log}(\mathbb{E}\text{(Race Count))} = \beta_0 + \beta_1\text{(Age in Years)} + \beta_2\text{(Race Year = 2020)} + \beta_3\text{(Race Year = 2021)}$$

Then, we calculated the standardized residual for each horse. 

**The standardized residual for the $i^{th}$ observation is defined as follows:**

$$i^{th}\text{ Standardized Residual }= \frac{y_i - \hat{y_i}}{SE}$$

*where SE is the standard error of the residuals, $y_i$ is the actual number of races for the $i^{th}$ observation, and $\hat{y}_i$ is the predicted number of races for the $i^{th}$ observation* [@std-resid].

**Finally, we classified a horse as under-racing if their standardized residual fell below -1 for *any* combination of their age and the calendar year that appeared in the data set.** 

### Motivation and Implementation of STRAIN

In materials science, [@materialScience] strain measures the deformation of a material from stress as the change in its length relative to its original length. Formally, let $D(t)$ be the distance between any two points of interest within a material at time $t$ and $D_0$ be the initial distance between those same points. The strain for a given material at time $t$ is defined as

$$\epsilon(t)=\frac{D(t)-D_0}{D_0}.$$

This metric is a ratio of two quantities of the same unit and is therefore unitless.

Accordingly, strain rate measures the change in the deformation of a material with respect to time. Mathematically, the strain rate of a material is expressed as the derivative of its strain, that is:

$$\epsilon'(t)=\frac{d \epsilon}{dt}=\frac{v(t)}{D_0},$$

where $v(t)$ is the velocity at which two points of interest within a material are moving away from or towards each other. This metric, unlike strain, is measured in inverse of time, typically inverse second.

Motivated by its scientific definition and previous work analyzing NFL pass rushing [@Quang], we draw an analogy between strain rate and horse racing. Just as strain rate is a measure of deformation in materials science, horses in a race apply deformation to one another in an effort to break away from the pack and win the race. Each horse can be viewed as a "particle", with strain rate calculated pairwise between each horse.

In order to apply this metric to horse racing, we draw inspiration from previous work analyzing NFL pass rushing [@Quang] and introduce slight modifications to how the concept is usually defined. Let $(x_{ijt}, y_{ijt})$ be the $(x, y)$ location on the track of horse $j=1,2,...,J_i$ at frame $t=1,2,...,T_i$ for race $i=1,2,...,n$.

* The distance between any two distinct horses $j$ and $j^*$ at frame $t$ during race $i$ is

$$s_{ijj^*}(t)=\sqrt{(x_{ijt}-x_{ij^*t})+(y_{ijt}-y_{ij^*t})}.$$

* The velocity at which two distinct horses $j$ and $j^*$ are moving towards each other at frame $t$ during race $i$ is

$$v_{ijj*}(T)=s'_{ijj*}(t)=\frac{ds_{ijj*}(t)}{dt}$$

* The STRAIN between two distinct horses $j$ and $j^*$ at frame $t$ during race $i$ is

$$STRAIN_{ijj^*}(t)=\frac{-v_{ijj*}(t)}{s_{ijj*}(t)}.$$

To distinguish this metric from strain and strain rate in materials science, we write it in capital letters (STRAIN) for the remainder of this report.

Similarly to previous work on pass rushing analysis, we negate the approach velocity $v_{ij}(t)$ between horses to ensure STRAIN increases as the distance between horses decreases. Additionally, the initial distance $s_{ij}(t)$ between horses is updated frame-by-frame, enabling the calculation of STRAIN for each frame throughout a race.

Since distance and velocity are observed discretely in increments of 4 frames/second, a point estimate for our STRAIN metric between distinct horses $j$ and $j^*$ at frame $t$ during race $i$ is

$$\widehat{STRAIN_{ijj^*}(t)}=\frac{-\frac{s_{ijj^*}(t)-s_{ijj^*}(t-1)}{0.25}}{s_{ijj^*}(t)}.$$

This measure increases in two ways: 1) the rate at which two horses are moving towards each other increases, and 2) the distance between two horses decreases. Both of these are indicators that a horse is moving towards the pack and running under higher stress.

Additionally, since we observe STRAIN between every pair of horses in a race, we can compute the total STRAIN for a horse at each frame. Let $Z_i$ represent the set of opposing horses in race $i$. Formally, the total STRAIN for a horse $j$ at frame $t$ during race $i$ is

$$STRAIN_{ij}(t) = \sum_{j^* \in Z_i} \widehat{STRAIN_{ijj^*}(t)}.$$

Additionally, to control for the number of horses in a race, we also consider the average total STRAIN of a horse, denoted by $\overline{STRAIN}$. Let $Z_i$ represent the set of opposing horses in race $i$. For a horse $j$ at frame $t$ during race $i$, average total STRAIN is

$$\overline{STRAIN_{ij}}(t) = \frac{1}{|Z_i|}*\sum_{j^* \in Z_i} \widehat{STRAIN_{ijj^*}(t)}.$$

Both of these metrics are useful for evaluating the magnitude of STRAIN experienced by horses in a race and provide novel features for predicting future injury.

#### Principal Component Analysis

Principal component analysis (PCA) is an unsupervised learning method used for dimensionality reduction (Jolliffe, 2002). It works by transforming to a new set of variables, referred to as principal components (PCs), which are independent of one another, and are ordered in terms of maximizing the variance explained in the original dataset. (Shlens, 2014). In this context, we did not apply PCA directly on the NYRA tracking data itself--we first computed numerous summary statistics upon features in the data such as median horse speed, average horse acceleration, maximum strain rate, and range of lateral movement. We then performed principal component analysis on the set summary statistics of the features separate from one another. Using a 90% threshold for cumulative proportion of variance explained, we took the top variable from the corresponding principal component. 

```{r table, fig.cap = "Number of Relevant Summary Statistics for each Feature"}
features <-  c("Speed", "Acceleration", "Lateral Movement", "Strain Rate")
num_sum <- c("4", "4", "4", "5")

sums_tbl <- data.frame(features, num_sum)
colnames(sums_tbl) <- c("Features", "Number of Summary Statistics, as determined from PCA")

knitr::kable(sums_tbl)
```


### Clustering Horse Trajectories

We utilized a Gaussian Mixture Model (GMM) to categorize the 4,588 horses into different clusters based upon their values for the relevant summary statistics (note that one horse was omitted from the analysis, as it has no information available for its races in 2019). A Gaussian Mixture Model is a probabilistic model that assumes the data is generated from a mixture of Gaussian distributions. Its advantages include flexibility (employing Bayesian information criterion, a penalized likelihood measure, to determine the number of clusters), soft clustering (probabilistic approach, as opposed to deterministic), and data generation (Fraley, C., & Raftery, A. E., 2002).

```{r clustering prep, fig.cap="Cluster Assignments for Speed Features"}
acceleration_summaries <- read_csv("../clustering-results-revised/acceleration-summaries.csv") |> 
  select(-`...1`)
side_mvmt_summaries <- read_csv("../clustering-results-revised/lateral-movement-summaries.csv") |> 
  select(-`...1`)
speed_summaries <- read_csv("../clustering-results-revised/speed-summaries.csv") |> 
  select(-`...1`)
strains_summaries <- read_csv("..clustering-results-revised/strain-summaries.csv") |> 
  select(-`...1`)

# read in profiles
horse_profiles <- read_csv("../outputted-csvs/horse_profiles.csv") |>
  filter(horse_id != 3563) # horse with no data
# join profile data
accel_profiles <- left_join(acceleration_summaries, horse_profiles,
                            by = c("horse_id", "horse_name"))
lat_mvmt_profiles <- left_join(side_mvmt_summaries, horse_profiles,
                               by = c("horse_id", "horse_name"))
speed_profiles <- left_join(speed_summaries, horse_profiles,
                            by = c("horse_id", "horse_name"))
strain_profiles <- left_join(strains_summaries, horse_profiles,
                             by = c("horse_id", "horse_name"))

# cluster example
knitr::kable(x=table(speed_profiles$cluster), 
             col.names = c("Cluster Number", "Number of Horses"))
```


----

## Results


### Horses who Under-Raced

Figure \@ref(fig:model) shows that all the coefficients in our fitted model have a p-value of approximately 0, meaning that age (in years) and the calendar year (compared to 2019) are significant predictors of expected race counts for a horse. One caveat is that our standardized residuals appear skew right rather than symmetrical around zero (Figure \@ref(fig:model)). Though, the distribution of standardized residuals still has a mean value of 0 and a variance of approximately 1, with 95.5% of the standardized residuals being within two standard deviations of the mean value of 0. Therefore, our Negative Binomial model is appropriate for predicting the expected race count for each combination of age and calendar year in the data set.    


```{r}
horse_names <- read_csv("../horse-cooking-data/horse_names.csv")
participation_data <- read_csv("../horse-cooking-data/horses_3years_racing_NYRA.csv") |>
  rename(horse_name = `horse name`,
         birth_date = `birth date`,
         race_date = `race date`) |>
  drop_na(horse_name)
horse_profiles_injured <- read_csv("../outputted-csvs/horse_profiles.csv") |>
  filter(if_injury_reported == TRUE) 

#### append horse names to participation data ####
## remove 2022 because only race from that year is from 01/01/2022

id_participation_data <- participation_data |>
  left_join(horse_names, by = 'horse_name') |>
  mutate(race_year = year(race_date)) |>
  filter(!(race_year == 2022))

#### building participation model

participation_data_model <- id_participation_data |>
  mutate(
    age = as.period(interval(start = birth_date, end = race_date)),
    age_year = year(age),
    race_year = as.factor(race_year)) |> 
  drop_na(horse_id, age_year) |> 
  group_by(horse_id, age_year, race_year) |> 
  summarize(n_races = n(), .groups = "keep")

nb_model <- glm.nb(n_races ~ age_year + race_year, data = participation_data_model)

#### using MASS package to get standardized residuals ####

model_resids <- MASS::stdres(nb_model) |> 
  as_tibble() |>
  rename(.std.resid = value) |>
  cbind(participation_data_model)
```


```{r}
table <- nb_model |>
  tidy() |>
  rename(Term = term) |>
  mutate(Estimate = round(estimate, 3),
         `Standard Error` = round(std.error, 3),
         Statistic = round(statistic, 3),
         `P-value` = round(p.value, 3)) |>
  select(Term, Estimate, `Standard Error`, Statistic, `P-value`)
```


```{r fig.cap = "Distribution of Standardized Residuals for Expected Race Count of a horse given their age (in years) and the calendar year (ranging from 2019 to 2021)."}
#### visualizing standardized residuals #####
p1 <- model_resids|> 
  mutate(under_raced = if_else(.std.resid < -1, TRUE, FALSE)) |>
  ggplot(aes(x=.std.resid)) +
  geom_histogram(aes(fill = under_raced), binwidth = .15, alpha = 0.75)+
  scale_x_continuous(breaks = seq(-2,6,1))+
  scale_y_continuous(breaks = seq(0,800,50))+
  labs(x = "Standardized Residual", y = "Count")+
  theme_minimal()+
  scale_fill_tableau()+
  guides(fill = guide_legend(title = "Under-Raced?"))+
  theme(text = element_text(size = 8), axis.title = element_text(size = 10),
        legend.position = c(.75, .75), 
        legend.background = element_rect(fill="white", colour ="grey90"))

t1 <- tableGrob(table, theme=ttheme_minimal(base_size = 8), rows=NULL)
```


```{r model, out.width='120%', out.height= '50%', fig.cap = "Evaluation Visualizations for Expected Race Count Model"}
grid.arrange(p1, t1, nrow=1)
```


Of the 931 horses were able to analyze for under-racing given their age and the calendar year, we found that 251 unique horses under-raced between 2019 and 2021. 75 out of those 251 horses under-raced more than once. Only one horse who under-raced had a severe injury reported in 2019 and the year they under-raced was 2021. No horses with a standardized residual less than -1 had a fatal injury in 2019 (Figure \@ref(fig:fitted-resid)). 

```{r fitted-resid, out.width='70%', fig.cap= "Standardized Residuals versus Fitted Values for Race Count given the Horse's Age and the Calendar Year"}
injured <- model_resids |>
  cbind(nb_model$fitted.values) |>
  mutate(under_raced = if_else(.std.resid < -1, TRUE, FALSE)) |>
  rename(.fitted = `nb_model$fitted.values`) |>
  left_join(horse_profiles_injured, by = "horse_id") |>
  select(horse_id, age_year, race_year, n_races, .fitted, .std.resid, if_injury_reported, fatal) |>
  filter(if_injury_reported == TRUE)


gg <- model_resids |>
  cbind(nb_model$fitted.values) |>
  mutate(under_raced = if_else(.std.resid < -1, TRUE, FALSE)) |>
  rename(.fitted = `nb_model$fitted.values`) |>
  left_join(horse_profiles_injured, by = "horse_id") |>
  select(horse_id, age_year, race_year, n_races, .fitted, .std.resid, if_injury_reported, fatal) |>
  ggplot(aes(x = .fitted, y = .std.resid))+
  geom_segment(linetype= 2, x = 0, xend = 10.2, y = -1, yend = -1, color = "grey30", alpha = .5)+
  geom_point(alpha = .1)+
  geom_point_interactive(data = injured, aes(x = .fitted, y = .std.resid, color = as.factor(horse_id),
                                             tooltip = paste0("Standard Residual: ", round(.std.resid, 3), "\nYear: ", race_year,"\nRace Count: ",n_races), data_id = .std.resid), size = 2.5)+
  scale_y_continuous(breaks = seq(-2,10,.5))+
  scale_x_continuous(limit = c(2.9, 10), breaks = seq(3,10,1))+
  labs(x = "Fitted Value", y = "Standardized Residual")+
  annotate("text", x = 9.4, y = -.8, label = "Under-Racing Cut-Off", size = 2.5, color = "grey30")+
  guides(color = guide_legend(title = "Injured Horse ID", order = 1))+
  scale_colour_tableau()+
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5, size = 12))

girafe(ggobj = gg,
       options = list(opts_tooltip(use_fill = TRUE, opacity = 1)))
```

Examining the horses with severe injuries in 2019 further, we found that horses with severe injuries were more likely to race more than their expected count in 2019 (Figure \@ref(fig:bar-injury)). In contrast, in 2020 and 2021, these horses were more likely to race less than expected but not significantly so, given only one severely injured horse had a standardized residual less than -1 during 2020 and 2021 (Figure \@ref(fig:fitted-resid) and \@ref(fig:bar-injury)). These results gives us some evidence that horses who become severely injured are actually more likely to over-race than under-race relative to other horses their age in a given calendar year.

```{r bar-injury, fig.cap = "Comparison Between Racing More or Less than Expected\nfor Horses who were Severely Injured in 2019"}
model_resids |>
  cbind(nb_model$fitted.values) |>
  mutate(under_raced = if_else(.std.resid < -1, TRUE, FALSE),
         over_expected = if_else(.std.resid > 0, "Over the Expected Count", "Under the Expected Count")) |>
  mutate(over_expected = fct_relevel(over_expected, "Under the Expected Count", "Over the Expected Count")) |>
  rename(.fitted = `nb_model$fitted.values`) |>
  left_join(horse_profiles_injured, by = "horse_id") |>
  select(horse_id, age_year, race_year, over_expected, n_races, .fitted, .std.resid, if_injury_reported, fatal) |>
  filter(if_injury_reported == TRUE) |>
  ggplot(aes(x = over_expected))+
  geom_bar(aes(fill = fct_relevel(as.factor(race_year), "2021", "2020", "2019")), 
           color = "black", alpha = 0.75)+
  scale_y_continuous(breaks = seq(0,22,2))+
  labs(x = "", y = "Count")+
  guides(fill = guide_legend(title = "Race Year"))+
  scale_fill_tableau()+
  theme_minimal()+
  theme(text = element_text(size = 14, color = "black"), axis.text.x = element_text(size = 12, color = "black"), plot.title = element_text(hjust = 0.5, size = 14, color = "black"))
```

### Cluster Membership for Horses that Under-Raced or had a Reported Injury  

Figure 5 below shows the proportion of horses in each cluster who suffered an injury for each of speed, acceleration, strain rate, and lateral movement. We found that the 8th cluster of the speed movement profile saw a proportion of injured horses that is close to 50%. Considering there are only 15 horses in this cluster--less than one percent of all horses in the data--there is evidence of a cluster 8 being representative of a potentially harmful speed profile. Similar conclusions can be drawn for Cluster 8 of the acceleration profiles: a significant proportion of injuries (approximately 25%) with a small sample size (27 horses). However, unlike the aforementioned clusters, Cluster 5 of the speed profiles has a larger proportion of horses (138 horses, or 3% of all horses in the data), and a relatively significant proportion of injuries (> 10%).

```{r, fig.cap="Clustering of Horse Movement Profiles, Colored by Injury"}
# injury viz ####

# be sure figure number in text matches figure number of plot
speed_injruies_plot <- speed_profiles |> 
  mutate(report_plot = 
           if_else(if_injury_reported == T, "Yes", "No")) |> 
  ggplot(aes(x = cluster, fill = report_plot)) + 
  geom_bar(position = "fill") + scale_fill_brewer(
    type = "qual", palette = "Set1", direction = -1) + 
  scale_x_discrete() + theme_classic() + 
  labs(subtitle = "Horses Clustered by Speed Profiles",
       x = "Clusters",y = "Proportion", 
       fill = "Injury Reported?") + 
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

accel_injruies_plot <- accel_profiles |> 
  mutate(report_plot = 
           if_else(if_injury_reported == T, "Yes", "No")) |> 
  ggplot(aes(x = cluster, fill = report_plot)) + 
  geom_bar(position = "fill") + scale_fill_brewer(
    type = "qual", palette = "Set1", direction = -1) + 
  scale_x_discrete() + theme_classic() + 
  labs(subtitle = "Horses Clustered by Acceleration Profiles",
       x = "Clusters",y = "Proportion", 
       fill = "Injury Reported?") + 
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

lat_mvmt_injruies_plot <- lat_mvmt_profiles |> 
  mutate(report_plot = 
           if_else(if_injury_reported == T, "Yes", "No")) |> 
  ggplot(aes(x = cluster, fill = report_plot)) + 
  geom_bar(position = "fill") + scale_fill_brewer(
    type = "qual", palette = "Set1", direction = -1) + 
  scale_x_discrete() + theme_classic() + 
  labs(subtitle = "Horses Clustered by Lateral Movement Profiles",
       x = "Clusters",y = "Proportion", 
       fill = "Injury Reported?") + 
  theme(legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

strain_injruies_plot <- strain_profiles |> 
  mutate(report_plot = 
           if_else(if_injury_reported == T, "Yes", "No")) |> 
  ggplot(aes(x = cluster, fill = report_plot)) + 
  geom_bar(position = "fill") + scale_fill_brewer(
    type = "qual", palette = "Set1", direction = -1) + 
  scale_x_discrete() + theme_classic() + 
  labs(subtitle = "Horses Clustered by Strain Rate Profiles",
       x = "Clusters",y = "Proportion", 
       fill = "Injury Reported?") + 
  theme(legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

cowplot::plot_grid(speed_injruies_plot, accel_injruies_plot,
                   lat_mvmt_injruies_plot, strain_injruies_plot,
                   ncol = 2)
```

Upon further investigation, it's clear that Speed Cluster 8 displays greater variation in horse speed other clusters (see Table 3). Specifically, Cluster 8 has the greatest range of average speed and the greatest coefficient of variation of speed. Furthermore, possessing the lowest average median speed and average minimum speed respectively could signal horses who are fatigued or hurt prior to suffering serious injuries.

```{r, fig.cap="Speed Summary Statistics for Each Cluster"}
speed_var_table <- speed_profiles |> 
  filter(horse_id != 2260, horse_id != 1842) |> 
  group_by(cluster) |> 
  summarize(avg_median_speed = mean(median_speed),
            avg_min_speed = mean(min_speed),
            avg_max_speed = mean(max_speed),
            avg_cv_speed = mean(cv_speed),
            avg_race_distance = mean(avg_race_dist_meters),
            avg_weight_carried = mean(avg_weight_carried)) |> 
  arrange(desc(avg_cv_speed))
colnames(speed_var_table) <- c("Cluster", "Average Median Speed",
                               "Average Min. Speed",
                               "Average Max. Speed",
                               "Average CV Speed",
                               "Average Race Distance",
                               "Average Weight Carried")
knitr::kable(speed_var_table, digits = 2)
```

Figure 6 displays the proportion of horses in each cluster who raced less than expected for 2019, 2020, or 2021 for each of speed, acceleration, strain rate, and lateral movement profiles. The relative proportion of injuries is both consistent within clusters and between clusters, suggesting that these trajectories are not indicative of potentially harmful profiles. It should be noted that some clusters have a proportion that is approximately zero. This is likely due to having a higher proportion of injured horses, not age, as seen in the previous model. Those horses who suffer an injury are often kept out of races for an extended period of time, so they are racing as expected, given that they suffered an injury.

```{r, fig.cap="Clustering of Horse Movement Profiles, Colored by Under-Recing}
# under-racing viz ####
speed_underrace <- speed_profiles |>
  mutate(report_plot = 
           if_else(ever_under_raced == T, "Yes", "No")) |> 
  ggplot(aes(x = cluster, 
             fill = report_plot)) + 
  geom_bar(position = "fill") + 
  scale_fill_brewer(type = "qual", 
                    palette = "Set1", direction = -1) + 
  scale_x_discrete() + theme_classic() + 
  labs(subtitle = "Clustered by Speed Profiles",
       x = "Clusters",y = "Proportion", 
       fill = "Ever Under-Raced? (2019-2021)") + 
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

accel_underrace <- accel_profiles |>
  mutate(report_plot = 
           if_else(ever_under_raced == T, "Yes", "No")) |> 
  ggplot(aes(x = cluster, 
             fill = report_plot)) + 
  geom_bar(position = "fill") + 
  scale_fill_brewer(type = "qual", 
                    palette = "Set1", direction = -1) + 
  scale_x_discrete() + theme_classic() + 
  labs(subtitle = "Clustered by Acceleration Profiles",
       x = "Clusters",y = "Proportion", 
       fill = "Ever Under-Raced? (2019-2021)") + 
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

lat_underrace <- lat_mvmt_profiles |>
  mutate(report_plot = 
           if_else(ever_under_raced == T, "Yes", "No")) |> 
  ggplot(aes(x = cluster, 
             fill = report_plot)) + 
  geom_bar(position = "fill") + 
  scale_fill_brewer(type = "qual", 
                    palette = "Set1", direction = -1) + 
  scale_x_discrete() + theme_classic() + 
  labs(subtitle = "Clustered by Lateral Movement Profiles",
       x = "Clusters",y = "Proportion", 
       fill = "Ever Under-Raced? (2019-2021)") + 
  theme(legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

strain_underrace <- strain_profiles |>
  mutate(report_plot = 
           if_else(ever_under_raced == T, "Yes", "No")) |> 
  ggplot(aes(x = cluster, 
             fill = report_plot)) + 
  geom_bar(position = "fill") + 
  scale_fill_brewer(type = "qual", 
                    palette = "Set1", direction = -1) + 
  scale_x_discrete() + theme_classic() + 
  labs(subtitle = "Clustered by Strain Rate Profiles",
       x = "Clusters",y = "Proportion", 
       fill = "Ever Under-Raced? (2019-2021)") + 
  theme(legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

cowplot::plot_grid(speed_underrace, accel_underrace,
                   lat_underrace, strain_underrace,ncol = 2)

```

----

## Conclusion

### Limitations

During this project, our main limitations came from data availability. In particular, calculating some of the frame-specific metrics from the tracking data involved immense computational power. One such example is lateral movement, which we could only acquire for 1600 meter races by Brendan Kumagai graciously sharing his processed data with us. Therefore, we could only analyze lateral movement for horses who ran a 1600 meter race during 2019, reducing our data set to 1678 horses, compared to the data set of 4638 horses we had for strain and speed.

Along similar lines, we could only analyze 931 out of the 4638 horses for under-racing because the NYRA Start Data was limited. Hence we likely under-estimates the *true* number of horses who under-raced between 2019 and 2021, which in turn limited our ability to identify injury trends in our movement profile clusters.

### Future Work

**Below are some ideas for future work based on our project:**

* Collecting more starts information to close the gap between the number of horses tracked in 2019 and the number of horses analyzed for under-racing to generate more injury signal.

* Computing lateral movement for all distances, rather than just 1600m races, to provide more information about lateral movement and its relationship to injury risk.

* Using a multilevel model to incorporate the distribution of horses as a random effect to capture some of the variation in the data without losing information.

----

## Acknowledgements

We thank Dr. Ron Yurko and Quang Nguyen for all their guidance and encouragement during this project. Additionally, we are thankful to our external partners at NYRA, particularly Joe Appelbaum and Davis Klein, for offering us domain-specific advice. We are also thankful to Brendan Kumagai and his Big Data Derby 2022 team for sharing their data cleaning code and processed data set. Finally, we would like to express our gratitude to Meg Ellingwood, Shamindra Shrotriya, and the rest of SURE 2023 for the opportunity to conduct sports analytics research this summer.

----

## References

